@Library('pipelib@master') _

node {
  def root = pwd()

  stage('Setup') {
    git([
      url: 'https://github.com/venicegeo/dg-pz-gocommon',
      branch: "master"
    ])
  }

  stage('Archive') {
    deleteDir()
    withGolang {
      sh """
      ls -R ./gopath/src/github.com
        go get github.com/venicegeo/dg-pz-gocommon/gocommon
        ls -R ./gopath/src/github.com
        go get github.com/braintree/manners
        go get github.com/gin-gonic/gin
        go get github.com/stretchr/testify/assert
        cd \$GOPATH/src/github.com/venicegeo/dg-pz-gocommon

        head -30 elasticsearch/common.go

        for i in gocommon elasticsearch kafka syslog
        do
          cd \$i
          go test -v
          cd ..
        done

        cd ${root}

        tar -cvzf pz-gocommon.tgz \
            glide.lock \
            glide.yaml
      """
    }
    mavenPush()
  }

  stage('Cleanup') {
    deleteDir()
  }
}
